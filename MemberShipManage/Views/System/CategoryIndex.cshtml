@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model List<MemberShipManage.Domain.Category>

<div id="rebate" class="margin-t10">
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">
                <label></label>
            </h3>
        </div>
        <div class="panel-content padding-5">
            <table id="categoryList" class="table table-striped table-bordered table-condensed">
                <tr style="background-color:#eee;height:35px;">
                    <th>类别名称</th>
                    <th>操作</th>
                </tr>
                @if (Model != null && Model.Count > 0)
                {
                    foreach (var category in Model)
                    {
                        <tr>
                            <td>@(category.Name ?? string.Empty)</td>
                            <td style="width:140px">
                                <button type="button" class="btn btn-primary"
                                        onclick="showCategoryModal('@category.ID','@category.Name')">
                                    编辑
                                </button>&nbsp;
                                <button type="button" class="btn btn-danger"
                                        onclick="deletCategory('@category.ID')">
                                    删除
                                </button>
                            </td>
                        </tr>
                    }
                }
            </table>
            <button type="button" class="btn btn-primary" onclick="showCategoryModal(null,null)">新增</button>
        </div>
    </div>
</div>
@Html.Partial("~/Views/System/CategoryUpdate.cshtml")
<link rel="stylesheet" href="~/Content/bootStrap/validator/css/bootstrapValidator.min.css" />
<script type="text/javascript" src="~/Content/bootStrap/validator/js/bootstrapValidator.min.js"></script>
<script type="text/javascript">
    function showCategoryModal(categoryID, categoryName) {
        $('#categoryname').val(categoryName);
        $('#hfdCategoryID').val(categoryID);
        $('#categoryUpdateModal').modal('show');
    }

    function deletCategory(categoryID) {
        if (!confirm('您确定要删除吗？')) return;

        $.ajax({
            url: '@Url.Action("RemoveCategory", "System")' + '?categoryID=' + categoryID,
            type: 'delete',
            success: function (result) {
                if (result.IsSuc) {
                    messager.showSuccess('删除成功！');
                    window.location.href = window.location.href;
                }
                else {
                    messager.showError(result.Msg);
                }
            }
        });
    }

    $(function () {
        registerValidator();
        $('#categoryUpdateModal').on('hide.bs.modal',
            function () {
                $("#categoryupdate").data('bootstrapValidator').destroy();
                $('#categoryupdate').data('bootstrapValidator', null);
                registerValidator();
                window.location.href = window.location.href;
                clearform();
            });

        function registerValidator() {
            $('#categoryupdate').bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    categoryname: {
                        validators: {
                            notEmpty: {
                                message: '类别名称不能为空'
                            },
                            stringLength: {
                                min: 1,
                                max: 25,
                                message: '类别名称必须在1到25之间'
                            }
                        }
                    }}
                }).on('success.form.bv', function (e) {//点击提交之后
                    e.preventDefault();
                    var $form = $(e.target);
                    var categoryID = $('#hfdCategoryID').val();

                    $.ajax({
                        url:  categoryID? $form.attr('action'):'@Url.Action("CreateCategory", "System")',
                        type: categoryID ? 'put':'post',
                        data: $form.serialize(),
                        success: function (result) {
                            if (result.IsSuc) {
                                if (categoryID) {
                                    messager.showSuccess("修改成功！");
                                }
                                else {
                                    messager.showSuccess("保存成功！");
                                }
                                $('#categoryUpdateModal').modal('hide');
                            }
                            else {
                                messager.showError(result.Msg);
                            }
                        }
                    });
                });
        }

        function clearform() {
            $('#categoryname').val('');
            $('#hfdCategoryID').val('');
        }
    });
</script>